<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>üñ®Ô∏è G√©n√©rateur BL avec QR Code - Wimb√©e</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 30px auto; padding: 20px; }
        h1 { color: #2c3e50; }
        input, select { width: 100%; padding: 8px; margin: 5px 0 15px; border: 1px solid #ccc; }
        button { background: #27ae60; color: white; padding: 12px 20px; border: none; cursor: pointer; font-size: 16px; }
        button:hover { background: #229954; }
        #qrcode { margin: 20px 0; text-align: center; }
        .mp-line { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .btn-add { background: #3498db; }
        .btn-print { background: #e67e22; }
    </style>
</head>
<body>
    <h1>üñ®Ô∏è G√©n√©rateur de Bon de Livraison avec QR Code</h1>
    <p><strong>Pour Wimb√©e</strong> ‚Äî Conforme BRC ‚Äî Version 3.0</p>

    <label>Code Fournisseur (ex: FR001) :</label>
    <input type="text" id="fournisseur" placeholder="FR001" required>

    <label>N¬∞ de commande Wimb√©e :</label>
    <input type="text" id="commande" placeholder="CMD-WIM-2025-001" required>

    <label>N¬∞ de r√©f√©rences Wimb√©e :</label>
    <input type="text" id="ref_wimbee" placeholder="WIM-CAM-250" required>

    <label>Date de Livraison :</label>
    <input type="date" id="date" value="2025-04-05" required>

    <div id="mp-lines">
        <div class="mp-line">
            <h3>üì¶ Mati√®re Premi√®re 1</h3>
            <label>D√©signation produit (ex: Bo√Æte Camembert 250g) :</label>
            <input type="text" class="designation" placeholder="Bo√Æte Camembert 250g" required>
            <label>R√©f produit (ex: WIM-CAM-250) :</label>
            <input type="text" class="ref_produit" placeholder="WIM-CAM-250" required>
            <label>N¬∞ de lot fournisseur :</label>
            <input type="text" class="lot_fourn" placeholder="LOTX7890" required>
            <label>Quantit√© :</label>
            <input type="number" class="quantite" placeholder="500" required> 
            <select class="unite">
                <option value="kg">kg</option>
                <option value="feuilles">feuilles</option>
                <option value="litres">litres</option>
            </select>
            <label>Nombre de palettes :</label>
            <input type="number" class="palettes" placeholder="5" min="1" required>
        </div>
    </div>

    <button class="btn-add" onclick="addMPLine()">‚ûï Ajouter une ligne de mati√®re</button>
    <button onclick="generateQR()">‚úÖ G√©n√©rer le QR Code + Bon de Livraison</button>

    <canvas id="qrcode" width="200" height="200"></canvas>

    <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimer ce Bon de Livraison</button>

    <script>
        let mpCount = 1;

        function addMPLine() {
            mpCount++;
            const div = document.createElement('div');
            div.className = 'mp-line';
            div.innerHTML = `
                <h3>üì¶ Mati√®re Premi√®re ${mpCount}</h3>
                <label>D√©signation produit (ex: Bo√Æte Brie 500g) :</label>
                <input type="text" class="designation" placeholder="ex: Bo√Æte Brie 500g" required>
                <label>R√©f produit (ex: WIM-BRI-500) :</label>
                <input type="text" class="ref_produit" placeholder="ex: WIM-BRI-500" required>
                <label>N¬∞ de lot fournisseur :</label>
                <input type="text" class="lot_fourn" placeholder="ex: LOTY7891" required>
                <label>Quantit√© :</label>
                <input type="number" class="quantite" placeholder="500" required> 
                <select class="unite">
                    <option value="kg">kg</option>
                    <option value="feuilles">feuilles</option>
                    <option value="litres">litres</option>
                </select>
                <label>Nombre de palettes :</label>
                <input type="number" class="palettes" placeholder="5" min="1" required>
            `;
            document.getElementById('mp-lines').appendChild(div);
        }

        function generateQR() {
            const fournisseur = document.getElementById('fournisseur').value;
            const commande = document.getElementById('commande').value;
            const ref_wimbee = document.getElementById('ref_wimbee').value;
            const date = document.getElementById('date').value;

            const lots = [];
            document.querySelectorAll('.mp-line').forEach(line => {
                const designation = line.querySelector('.designation').value;
                const ref_produit = line.querySelector('.ref_produit').value;
                const lot_fourn = line.querySelector('.lot_fourn').value;
                const quantite = line.querySelector('.quantite').value;
                const unite = line.querySelector('.unite').value;
                const palettes = line.querySelector('.palettes').value;

                if (designation && ref_produit && lot_fourn && quantite && palettes) {
                    lots.push({
                        designation_produit: designation,
                        reference_produit: ref_produit,
                        lot_fournisseur: lot_fourn,
                        quantite: parseFloat(quantite),
                        unite: unite,
                        nombre_palettes: parseInt(palettes)
                    });
                }
            });

            if (!fournisseur || !commande || !ref_wimbee || !date || lots.length === 0) {
                alert("‚ùå Veuillez remplir tous les champs obligatoires !");
                return;
            }

            const data = {
                type: "BL_FOURNISSEUR",
                fournisseur_code: fournisseur,
                commande_wimbee: commande,
                reference_wimbee: ref_wimbee,
                date_livraison: date,
                lots: lots
            };

            document.getElementById("qrcode").innerHTML = "";
            QRCode.toCanvas(document.getElementById("qrcode"), JSON.stringify(data), { width: 200, height: 200 }, function (error) {
                if (error) console.error(error);
                else console.log("QR Code g√©n√©r√© !");
            });
        }
    </script>
</body>
</html>
